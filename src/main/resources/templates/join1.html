<!DOCTYPE html>
<html lang="en" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <title>회원가입</title>
</head>
<body>
<!-- action속성: form에 작성한 데이터를 어디로 보낼지 지정 -->
<form th:action="@{/users/signup}" method="post">
    <!-- name속성: 서버로 전송할 때 변수이름의 역할 -->
    <label>아이디</label>
    <input type="text" name="username" id="username" onblur="idCheck()"> <br>
    <p id="id-check-result"></p>
    <label>비밀번호</label>
    <input type="password" name="memberPassword" id="password" required> <br>
    <label>비밀번호 확인</label>
    <input type="password" name="passwordConfirm" id="passwordConfirm" required> <br>
    <div id="passwordError" style="display:none; color: red;">비밀번호가 일치하지 않습니다.</div>

    <label>이름</label>
    <input type="text" name="memberName"> <br>

    <label>이메일</label>
    <input type="email" name="memberEmail" id="memberEmail" onblur="emailCheck()"> <br>

    <!-- 기존 코드 -->
    <button type="button" id="sendVerificationBtn" onclick="sendVerification()">인증번호 발송</button>
    <p id="email-check-result"></p>

    <!-- 이메일 인증번호 입력 폼 추가 -->
    <label>이메일 인증번호</label>
    <input type="text" name="emailVerificationCode" id="emailVerificationCode" onblur="checkVerificationCode()">
    <p id="verification-code-result"></p>

    <input type="submit" value="회원가입" id="joinButton">
</form>
</body>



<script th:inline="javascript">
    const emailCheck = () => {
        const email = document.getElementById("memberEmail").value;
        checkEmailAvailability(email, displayEmailCheckResult);
    }

    const displayEmailCheckResult = (result, email) => {
        const emailCheckResult = document.getElementById("email-check-result");
        // 각 결과에 따른 메시지 변경
        $.ajax({
            type: "post",
            url: "/member/email-check",
            data: {"memberEmail": email},
            success: function (res) {
                if (email === '') {
                    emailCheckResult.style.color = "red";
                    emailCheckResult.innerHTML = "이메일을 입력해주세요";
                } else if (res === "ok") {
                    emailCheckResult.style.color = "green";
                    emailCheckResult.innerHTML = "사용 가능한 이메일";
                } else {
                    emailCheckResult.style.color = "red";
                    emailCheckResult.innerHTML = "이미 사용 중인 이메일";
                }
            },
            error: function (err) {
                console.log("에러발생", err);
            }
        });
    }

    const idCheck = () => {
        const username = document.getElementById("username").value;
        checkUsernameAvailability(username, displayUsernameCheckResult);
    }

    const displayUsernameCheckResult = (result, username) => {
        const idCheckResult = document.getElementById("id-check-result");
        // 각 결과에 따른 메시지 변경
        if (result === "ok") {
            idCheckResult.style.color = "green";
            idCheckResult.innerHTML = "사용 가능한 아이디";
        } else if (username === "") {
            idCheckResult.style.color = "red";
            idCheckResult.innerHTML = "아이디를 입력해주세요";
        } else {
            idCheckResult.style.color = "red";
            idCheckResult.innerHTML = "이미 사용 중인 아이디";
        }
    }

    function displayEmailCheckResult(email) {
        $.ajax({
            url: "/email-check",
            data: { email: email },
            success: function (response) {
                if (response.result === "available") {
                    document.getElementById("email-check-result").innerHTML = "사용 가능한 이메일입니다.";
                } else {
                    document.getElementById("email-check-result").innerHTML = "이미 사용 중인 이메일입니다.";
                }
            }
        });
    }

    function displayUsernameCheckResult(username) {
        $.ajax({
            url: "/username-check",
            data: { username: username },
            success: function (response) {
                if (response.result === "available") {
                    document.getElementById("id-check-result").innerHTML = "사용 가능한 아이디입니다.";
                } else {
                    document.getElementById("id-check-result").innerHTML = "이미 사용 중인 아이디입니다.";
                }
            }
        });
    }

    const isValidForm = () => {
        return checkPasswordsMatch();
    }

    const checkPasswordsMatch = () => {
        let password = document.getElementById('password').value;
        let passwordConfirm = document.getElementById('passwordConfirm').value;

        if (password === passwordConfirm) {
            document.getElementById('passwordError').style.display = 'none';
            return true;
        } else {
            document.getElementById('passwordError').style.display = 'block';
            return false;
        }
    }


    document.getElementById('submitButton').addEventListener('click', handleFormSubmit);

    const handleFormSubmit = (event) => {
        if (checkPasswordsMatch()) {
            document.getElementById('passwordError').style.display = 'none';
        } else {
            document.getElementById('passwordError').style.display = 'block';
            event.preventDefault();
        }
    }

    const sendVerification = () => {
        const email = document.getElementById("memberEmail").value;
        const title = "[TODOS] 회원 가입 이메일 인증";
        const verificationCode = Math.floor(100000 + Math.random() * 900000);
        const content = `Todos에서 발송한 인증코드입니다. 인증 코드는 ${verificationCode}입니다`;

        $.ajax({
            type: "post",
            url: "/mail/sendVerification",
            data: { address: email, title: title, content: content },
            success: function (res) {
                if (res === "success") {
                    alert("인증코드가 발송되었습니다.");
                } else {
                    alert("이메일 발송 실패");
                }
            },
            error: function (err) {
                alert("오류 발생: " + err);
            },
        });
    };



    const checkVerificationCode = () => {
        // 인증번호 확인 및 결과 확인
        const email = document.getElementById('memberEmail').value;
        const code = document.getElementById('emailVerificationCode').value;
        const codeResult = document.getElementById('verification-code-result');

        $.ajax({
            type: 'POST',
            url: '/member/check-verification-code',
            data: { memberEmail: email, code: code },
            success: function (res) {
                if (res === 'success') {
                    codeResult.style.color = 'green';
                    codeResult.innerHTML = '인증번호가 일치합니다.';
                } else {
                    codeResult.style.color = 'red';
                    codeResult.innerHTML = '인증번호가 일치하지 않습니다.';
                }
            },
            error: function (err) {
                codeResult.style.color = 'red';
                codeResult.innerHTML = '오류 발생';
            },
        });
    }

    const beforeJoinSubmit = () => {
        // 이메일 인증 완료 확인
        const codeResult = document.getElementById("verification-code-result").innerText;
        return codeResult === "인증번호가 일치합니다";
    }

    document.getElementById('joinButton').addEventListener('click', handleJoinSubmit);

    const handleJoinSubmit = (event) => {
        if (beforeJoinSubmit()) {
            console.log("회원가입 완료");
        } else {
            event.preventDefault();
        }
    }

</script>
</html>